{% extends 'layouts/base_portal.html' %}
{% block title %}Dashboard — Tickets{% endblock %}

{% block conteudo %}
<div class="page-header">
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
    <a href="{% url 'tickets:ticket_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Novo Ticket
    </a>
</div>

<!-- Métricas principais -->
<div class="metrics">
    <div class="metric-card" style="border-left-color:#1a73e8;">
        <h3>Abertos</h3>
        <p style="color:#1a73e8;">{{ stats.total_abertos }}</p>
        <small>Total em aberto</small>
    </div>
    <div class="metric-card" style="border-left-color:#7c3aed;">
        <h3>Abertos Hoje</h3>
        <p style="color:#7c3aed;">{{ stats.novos_hoje }}</p>
        <small>Criados hoje</small>
    </div>
    <div class="metric-card" style="border-left-color:#dc2626;">
        <h3>Vencidos</h3>
        <p style="color:#dc2626;">{{ stats.vencidos }}</p>
        <small>Fora do prazo SLA</small>
    </div>
    <div class="metric-card" style="border-left-color:#16a34a;">
        <h3>Resolvidos (Mês)</h3>
        <p style="color:#16a34a;">{{ stats.resolvidos_mes }}</p>
        <small>Fechados este mês</small>
    </div>
    {% if user.is_staff %}
    <div class="metric-card" style="border-left-color:#d97706;">
        <h3>Meus Tickets</h3>
        <p style="color:#d97706;">{{ meus_tickets|default:0 }}</p>
        <small>Sob minha responsabilidade</small>
    </div>
    {% endif %}
</div>

<!-- Gráficos -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
    <div class="detail-card">
        <h2><i class="bi bi-bar-chart"></i> Tickets por Status</h2>
        <div class="detail-content">
            <canvas id="statusChart" style="max-height:220px;"></canvas>
        </div>
    </div>
    <div class="detail-card">
        <h2><i class="bi bi-pie-chart"></i> Tickets por Categoria</h2>
        <div class="detail-content">
            <canvas id="catChart" style="max-height:220px;"></canvas>
        </div>
    </div>
</div>

<!-- Tickets recentes -->
<div class="detail-card">
    <h2><i class="bi bi-clock-history"></i> Tickets Recentes</h2>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Assunto</th>
                    <th>Solicitante</th>
                    <th>Status</th>
                    <th>Urgência</th>
                    <th>Criado em</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td>
                        <a href="{% url 'tickets:ticket_detail' ticket.pk %}" style="font-weight:700;color:#1a73e8;">
                            #{{ ticket.numero }}
                        </a>
                    </td>
                    <td>{{ ticket.assunto|truncatewords:8 }}</td>
                    <td>{{ ticket.solicitante.get_full_name|default:ticket.solicitante.username }}</td>
                    <td>
                        <span class="badge" style="background:{{ ticket.status.cor }}22;color:{{ ticket.status.cor }};border:1px solid {{ ticket.status.cor }}55;">
                            {{ ticket.status.nome }}
                        </span>
                    </td>
                    <td>
                        {% if ticket.urgencia %}
                        <span class="badge" style="background:{{ ticket.urgencia.cor }}22;color:{{ ticket.urgencia.cor }};border:1px solid {{ ticket.urgencia.cor }}55;">
                            {{ ticket.urgencia.nome }}
                        </span>
                        {% else %}-{% endif %}
                    </td>
                    <td style="color:#9ca3af;font-size:13px;">{{ ticket.criado_em|date:"d/m H:i" }}</td>
                    <td>
                        <a href="{% url 'tickets:ticket_detail' ticket.pk %}" class="btn btn-sm btn-secondary">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7">
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>Nenhum ticket ainda</p>
                        <a href="{% url 'tickets:ticket_create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Criar Ticket
                        </a>
                    </div>
                </td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const statusLabels = [{% for s in por_status %}'{{ s.status__nome }}',{% endfor %}];
    const statusData   = [{% for s in por_status %}{{ s.total }},{% endfor %}];
    const statusColors = [{% for s in por_status %}'{{ s.status__cor }}',{% endfor %}];

    if (statusLabels.length && document.getElementById('statusChart')) {
        new Chart(document.getElementById('statusChart'), {
            type: 'bar',
            data: {
                labels: statusLabels,
                datasets: [{ label: 'Tickets', data: statusData, backgroundColor: statusColors, borderRadius: 5 }]
            },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    const catLabels = [{% for c in por_categoria %}'{{ c.categoria__nome|default:"Sem categoria" }}',{% endfor %}];
    const catData   = [{% for c in por_categoria %}{{ c.total }},{% endfor %}];

    if (catLabels.length && document.getElementById('catChart')) {
        new Chart(document.getElementById('catChart'), {
            type: 'doughnut',
            data: {
                labels: catLabels,
                datasets: [{ data: catData, backgroundColor: ['#1a73e8','#7c3aed','#dc2626','#16a34a','#d97706','#0891b2'] }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    }
});
</script>
{% endblock %}