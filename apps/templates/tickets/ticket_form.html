{% extends 'layouts/base_portal.html' %}
{% block title %}{% if object.pk %}Editar Ticket #{{ object.numero }}{% else %}Novo Ticket{% endif %}{% endblock %}

{% block conteudo %}
<div class="page-header">
    <h1><i class="bi bi-{% if object.pk %}pencil-square{% else %}plus-circle{% endif %}"></i>
        {% if object.pk %}Editar Ticket #{{ object.numero }}{% else %}Abrir Novo Ticket{% endif %}
    </h1>
    <a href="{% url 'tickets:ticket_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div style="background:#fee2e2;color:#dc2626;border:1px solid #fecaca;border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:14px;">
        {{ form.non_field_errors }}
    </div>
    {% endif %}

    <!-- Pessoas -->
    <div class="detail-card">
        <h2><i class="bi bi-people"></i> Pessoas</h2>
        <div class="form-grid">
            <div class="form-group">
                {{ form.solicitante.label_tag }}
                {{ form.solicitante }}
                {% if form.solicitante.errors %}<div class="text-danger">{{ form.solicitante.errors }}</div>{% endif %}
            </div>
            {% if user.is_staff %}
            <div class="form-group">
                {{ form.responsavel.label_tag }}
                {{ form.responsavel }}
                {% if form.responsavel.errors %}<div class="text-danger">{{ form.responsavel.errors }}</div>{% endif %}
            </div>
            {% endif %}
            <div class="form-group">
                {{ form.cc.label_tag }}
                {{ form.cc }}
                {% if form.cc.errors %}<div class="text-danger">{{ form.cc.errors }}</div>{% endif %}
                <span class="form-hint">E-mails separados por vírgula para cópia</span>
            </div>
        </div>
    </div>

    <!-- Classificação -->
    <div class="detail-card">
        <h2><i class="bi bi-tag"></i> Classificação</h2>
        <div class="form-grid">
            <div class="form-group">
                {{ form.categoria.label_tag }}
                {{ form.categoria }}
                {% if form.categoria.errors %}<div class="text-danger">{{ form.categoria.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                {{ form.urgencia.label_tag }}
                {{ form.urgencia }}
                {% if form.urgencia.errors %}<div class="text-danger">{{ form.urgencia.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                {{ form.servico.label_tag }}
                {{ form.servico }}
                {% if form.servico.errors %}<div class="text-danger">{{ form.servico.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                {{ form.tipo_ticket.label_tag }}
                {{ form.tipo_ticket }}
                {% if form.tipo_ticket.errors %}<div class="text-danger">{{ form.tipo_ticket.errors }}</div>{% endif %}
            </div>
        </div>
    </div>

    <!-- Status (só staff ou edição) -->
    {% if user.is_staff %}
    <div class="detail-card">
        <h2><i class="bi bi-arrow-repeat"></i> Status</h2>
        <div class="form-grid">
            <div class="form-group">
                {{ form.status.label_tag }}
                {{ form.status }}
                {% if form.status.errors %}<div class="text-danger">{{ form.status.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                {{ form.justificativa.label_tag }}
                {{ form.justificativa }}
                {% if form.justificativa.errors %}<div class="text-danger">{{ form.justificativa.errors }}</div>{% endif %}
                <span class="form-hint">Obrigatório em alguns status</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Descrição -->
    <div class="detail-card">
        <h2><i class="bi bi-card-text"></i> Detalhes</h2>
        <div class="form-grid">
            <div class="form-group full-width">
                {{ form.assunto.label_tag }}
                {{ form.assunto }}
                {% if form.assunto.errors %}<div class="text-danger">{{ form.assunto.errors }}</div>{% endif %}
            </div>
            <div class="form-group full-width">
                {{ form.descricao.label_tag }}
                {{ form.descricao }}
                {% if form.descricao.errors %}<div class="text-danger">{{ form.descricao.errors }}</div>{% endif %}
            </div>
            <div class="form-group">
                {{ form.tags.label_tag }}
                {{ form.tags }}
                {% if form.tags.errors %}<div class="text-danger">{{ form.tags.errors }}</div>{% endif %}
                <span class="form-hint">Palavras-chave separadas por vírgula</span>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <a href="{% url 'tickets:ticket_list' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg"></i>
            {% if object.pk %}Salvar Alterações{% else %}Abrir Ticket{% endif %}
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const catEl = document.getElementById('id_categoria');
    if (!catEl) return;
    catEl.addEventListener('change', function () {
        const id = this.value;
        if (!id) return;
        fetch(`/tickets/api/urgencias/${id}/`)
            .then(r => r.json())
            .then(data => {
                const sel = document.getElementById('id_urgencia');
                sel.innerHTML = '<option value="">---------</option>';
                (data.urgencias || []).forEach(u => {
                    const o = document.createElement('option');
                    o.value = u.id; o.textContent = u.nome;
                    sel.appendChild(o);
                });
            });
    });
});
</script>
{% endblock %}