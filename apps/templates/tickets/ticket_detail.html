{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Ticket #{{ ticket.numero }}{% endblock %}

{% block conteudo %}
<div class="content">
    <div class="page-header">
        <h1><i class="bi bi-ticket-detailed"></i> Ticket #{{ ticket.numero }}</h1>
        <div>
            <a href="{% url 'tickets:ticket_update' ticket.pk %}" class="btn btn-secondary">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <a href="{% url 'tickets:ticket_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Informações Principais -->
    <div class="detail-card">
        <h2>Informações do Ticket</h2>
        <div class="detail-content">
            <div class="detail-info">
                <div class="detail-row">
                    <span class="detail-label">Número:</span>
                    <span class="detail-value">#{{ ticket.numero }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="badge" style="background-color: {{ ticket.status.cor }}; color: white; padding: 5px 10px;">
                            {{ ticket.status.nome }}
                        </span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Solicitante:</span>
                    <span class="detail-value">{{ ticket.solicitante.get_full_name|default:ticket.solicitante.username }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Responsável:</span>
                    <span class="detail-value">{{ ticket.responsavel.get_full_name|default:ticket.responsavel.username|default:"-" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Categoria:</span>
                    <span class="detail-value">{{ ticket.categoria.nome|default:"-" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Urgência:</span>
                    <span class="detail-value">
                        {% if ticket.urgencia %}
                            <span class="badge" style="background-color: {{ ticket.urgencia.cor }}; color: white; padding: 5px 10px;">
                                {{ ticket.urgencia.nome }}
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Serviço:</span>
                    <span class="detail-value">{{ ticket.servico.nome|default:"-" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Criado em:</span>
                    <span class="detail-value">{{ ticket.criado_em|date:"d/m/Y H:i" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Atualizado em:</span>
                    <span class="detail-value">{{ ticket.atualizado_em|date:"d/m/Y H:i" }}</span>
                </div>
                {% if ticket.previsao_solucao %}
                <div class="detail-row">
                    <span class="detail-label">Previsão SLA:</span>
                    <span class="detail-value">
                        {% if ticket.esta_vencido %}
                            <span class="badge" style="background-color: #dc3545; color: white;">
                                <i class="bi bi-exclamation-triangle"></i> Vencido - {{ ticket.previsao_solucao|date:"d/m/Y H:i" }}
                            </span>
                        {% else %}
                            {{ ticket.previsao_solucao|date:"d/m/Y H:i" }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Assunto e Descrição -->
    {% if ticket.assunto or ticket.descricao %}
    <div class="detail-card">
        <h2>Detalhes</h2>
        <div class="detail-content">
            {% if ticket.assunto %}
                <div style="margin-bottom: 15px;">
                    <strong>Assunto:</strong><br>
                    {{ ticket.assunto }}
                </div>
            {% endif %}
            {% if ticket.descricao %}
                <div>
                    <strong>Descrição:</strong><br>
                    <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 8px;">
                        {{ ticket.descricao }}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Ações Rápidas -->
    <div class="detail-card">
        <h2>Ações Rápidas</h2>
        <div class="detail-content">
            <form method="post" action="{% url 'tickets:alterar_status' ticket.pk %}" style="display: inline-block; margin-right: 10px;">
                {% csrf_token %}
                {{ alterar_status_form.status }}
                {{ alterar_status_form.justificativa }}
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="bi bi-arrow-repeat"></i> Alterar Status
                </button>
            </form>
            <form method="post" action="{% url 'tickets:alterar_responsavel' ticket.pk %}" style="display: inline-block;">
                {% csrf_token %}
                {{ alterar_responsavel_form.responsavel }}
                <button type="submit" class="btn btn-sm btn-secondary">
                    <i class="bi bi-person"></i> Alterar Responsável
                </button>
            </form>
        </div>
    </div>

    <!-- Ações/Respostas -->
    <div class="detail-card">
        <h2>Ações e Respostas</h2>
        <div class="detail-content">
            <form method="post" action="{% url 'tickets:adicionar_acao' ticket.pk %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_tipo">Tipo de Ação:</label>
                    {{ acao_form.tipo }}
                </div>
                <div class="form-group">
                    <label for="id_conteudo">Conteúdo:</label>
                    {{ acao_form.conteudo }}
                </div>
                <div class="form-group">
                    <label for="id_tempo_trabalhado">Tempo Trabalhado (HH:MM:SS):</label>
                    {{ acao_form.tempo_trabalhado }}
                </div>
                <div class="form-group">
                    <label for="id_aplicar_macro">Aplicar Macro:</label>
                    {{ acao_form.aplicar_macro }}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Adicionar Ação
                </button>
            </form>

            <hr style="margin: 30px 0;">

            {% if acoes %}
                {% for acao in acoes %}
                <div style="border-left: 3px solid {% if acao.tipo == 'publica' %}#007bff{% elif acao.tipo == 'interna' %}#6c757d{% else %}#ffc107{% endif %}; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <span class="badge" style="background-color: {% if acao.tipo == 'publica' %}#007bff{% elif acao.tipo == 'interna' %}#6c757d{% else %}#ffc107{% endif %}; color: white;">
                                {{ acao.get_tipo_display }}
                            </span>
                            <strong>{{ acao.autor.get_full_name|default:acao.autor.username }}</strong>
                        </div>
                        <span style="color: #666; font-size: 14px;">{{ acao.criado_em|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div style="white-space: pre-wrap;">{{ acao.conteudo }}</div>
                    {% if acao.tempo_trabalhado %}
                        <div style="margin-top: 10px; font-size: 13px; color: #666;">
                            <i class="bi bi-clock"></i> Tempo trabalhado: {{ acao.tempo_trabalhado }}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: #999; padding: 30px 0;">
                    Nenhuma ação registrada ainda.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Anexos -->
    <div class="detail-card">
        <h2>Anexos</h2>
        <div class="detail-content">
            <form method="post" action="{% url 'tickets:adicionar_anexo' ticket.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_arquivo">Selecione o(s) arquivo(s):</label>
                    <input type="file" name="arquivo" multiple class="form-control" required>
                    <small>Máximo 25MB por arquivo</small>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-paperclip"></i> Adicionar Anexo
                </button>
            </form>

            <hr style="margin: 20px 0;">

            {% if anexos %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tamanho</th>
                                <th>Autor</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for anexo in anexos %}
                            <tr>
                                <td><i class="bi bi-file-earmark"></i> {{ anexo.nome_original }}</td>
                                <td>{{ anexo.tamanho|filesizeformat }}</td>
                                <td>{{ anexo.autor.username }}</td>
                                <td>{{ anexo.criado_em|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <a href="{{ anexo.arquivo.url }}" class="btn btn-sm btn-view" target="_blank" title="Baixar">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p style="text-align: center; color: #999; padding: 30px 0;">
                    Nenhum anexo adicionado ainda.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Histórico -->
    {% if historico %}
    <div class="detail-card">
        <h2>Histórico de Alterações</h2>
        <div class="detail-content">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Campo</th>
                            <th>Valor Anterior</th>
                            <th>Valor Novo</th>
                            <th>Usuário</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historico %}
                        <tr>
                            <td><strong>{{ item.campo }}</strong></td>
                            <td>{{ item.valor_anterior|default:"-" }}</td>
                            <td>{{ item.valor_novo|default:"-" }}</td>
                            <td>{{ item.usuario.username }}</td>
                            <td>{{ item.criado_em|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}