{% extends 'layouts/base.html' %}
{% block title %}Detalhe do Produto{% endblock %}
{% block conteudo %}
<div class="content">
    <!-- Cabeçalho -->
    <div class="page-header">
        <h1>Detalhe do Produto: {{ produto.nome }}</h1>
        <div class="filter-buttons">
            <a href="{% url 'produtos:produtos_form' produto.id %}" class="btn btn-edit">Editar Fornecedor</a>
            <button class="btn btn-delete" data-id="{{ produto.id }}">Excluir Fornecedor</button>
            <a href="{% url 'produtos:produtos_list' %}" class="btn btn-secondary">Voltar</a>
        </div>
    </div>
    <div class="detail-card">
        <div class="detail-content">
            <div class="detail-info">
                <div class="detail-row"><span class="detail-label">Categoria:</span> {{ produto.categoria }}</div>
                <div class="detail-row"><span class="detail-label">Marca:</span> {{ produto.marca }}</div>
                <div class="detail-row"><span class="detail-label">Fornecedor:</span> {{ produto.fornecedor }}</div>
                <div class="detail-row"><span class="detail-label">Status:</span>
                    {% if produto.status %}<span class="badge badge-success">Ativo</span>
                    {% else %}<span class="badge badge-danger">Inativo</span>
                    {% endif %}
                </div>
                <div class="detail-row"><span class="detail-label">Estoque:</span>
                    {% for v in produto.variacaoproduto.all %}
                        {{ v.tamanho|default:"-" }}: {{ v.quantidade|floatformat:2 }} {{ v.unidade }}<br>
                    {% empty %}
                        <span>-</span>
                    {% endfor %}
                </div>
                <div class="detail-row"><span class="detail-label">Preço custo:</span> R$ {{ produto.preco_custo|floatformat:2 }}</div>
                <div class="detail-row"><span class="detail-label">Preço venda:</span> R$ {{ produto.preco_venda|floatformat:2 }}</div>
                <div class="detail-row"><span class="detail-label">Descrição:</span> {{ produto.descricao|default:"-" }}</div>
                <div class="detail-row">
                    <span class="detail-label">Campos Personalizados:</span>
                    {% for valor in produto.valores_campos.all %}
                        <strong>{{ valor.campo.nome }}:</strong> {{ valor.valor }}<br>
                    {% empty %}Nenhum campo dinâmico cadastrado.<br>{% endfor %}
                </div>
            </div>
            <div class="detail-image">
                {% if produto.imagem %}
                    <img src="{{ produto.imagem.url }}" class="product-image" alt="{{ produto.nome }}">
                {% else %}
                    <div class="no-image">Sem imagem</div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Adicionar após as informações do produto -->
    <div class="detail-card">
        <h2>Variações</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Tamanho</th>
                    <th>Unidade</th>
                    <th>Quantidade</th>
                    <th>Estoque Mínimo</th>
                    <th>Código de Barras</th>
                    <th>QRCode</th>
                </tr>
            </thead>
            <tbody>
                {% for variacao in variacaoproduto %}
                    <tr>
                        <td>{{ variacao.tamanho }}</td>
                        <td>{{ variacao.unidade }}</td>
                        <td>{{ variacao.quantidade }}</td>
                        <td>{{ variacao.estoque_minimo }}</td>
                        <td>{% if variacao.barcode_image %}
                            <a href="{{ variacao.barcode_image.url }}" download="barcode_{{ variacao.codigo_barras|default:'produto' }}.png" class=" btn btn-sm btn-primary">Baixar</a>
                            {% else %}
                            <span class="detail-value">Não gerado</span>
                                
                            {% endif %}
                        </td>
                        <td>{% if variacao.barcode_image %}
                            <a href="{{ variacao.qr_code.url }}" download="qrcode_{{ variacao.codigo_barras|default:'produto' }}.png" class="btn btn-sm btn-primary">Baixar</a>
                            {% else %}
                            <span class="detail-value">Não gerado</span>
                                
                            {% endif %}
                        </td>    
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">Nenhuma variação cadastrada.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="detail-row"><span class="detail-label">Parâmetros de Estoque:</span>
        Mínimo: {{ produto.parametroestoque.estoque_minimo|default:"-" }}<br>
        Máximo: {{ produto.parametroestoque.estoque_maximo|default:"-" }}<br>
        Alerta de reposição: {{ produto.parametroestoque.alerta_reposicao|yesno:"Sim,Não" }}
    </div>

    <div class="detail-card">
        <h2>Composição</h2>
        <table class="table">
            <thead>
                <tr><th>Componente</th><th>Quantidade</th><th>Unidade</th></tr>
            </thead>
            <tbody>
            {% for comp in produto.produtocomposicao_set.all %}
                <tr>
                    <td>{{ comp.componente.nome }}</td>
                    <td>{{ comp.quantidade }}</td>
                    <td>{{ comp.unidade }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="3">Nenhum componente cadastrado.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="detail-card">
        <h2>Movimentações</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Tamanho</th>
                    <th>Tipo</th>
                    <th>Quantidade</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                {% for mov in movimentacao %}
                    <tr>
                        <td>{{ mov.variacao.produto.nome }}</td>
                        <td>{{ mov.variacao.tamanho }}</td>
                        <td>{{ mov.tipo }}</td>
                        <td>{{ mov.quantidade|floatformat:2 }} {{ mov.variacao.unidade }}</td>
                        <td>{{ mov.data|date:"d/m/Y H:i" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">Nenhuma movimentação registrada.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="detail-card">
        <h2>Lotes</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Tamanho</th>
                    <th>Núm. Lote</th>
                    <th>Quantidade</th>
                    <th>Fornecedor</th>
                    <th>Data Entrada</th>
                </tr>
            </thead>
            <tbody>
                {% for lote in loteproduto %}
                    <tr>
                        <td>{{ lote.variacao.produto.nome }}</td>
                        <td>{{ lote.variacao.tamanho }}</td>
                        <td>{{ lote.numero_lote }}</td>
                        <td>{{ lote.quantidade }}</td>
                        <td>{{ lote.fornecedor }}</td>
                        <td>{{ lote.data_entrada|date:"d/m/Y H:i" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">Nenhuma movimentação registrada.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
